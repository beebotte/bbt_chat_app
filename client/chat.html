<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Beebotte Chat demo</title>
  <link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
  <script src="//beebotte.com/cdn/bbt.min.js"></script>
    <style>
.module {
  margin: 10px 10px;
}

.discussion {
  list-style: none;
  margin: 0;
  padding: 0 0 0 0;
}
.discussion li {
  padding: 0.5rem;
  overflow: hidden;
}

.self {
  margin-left: 40px;
  background-color: #EEEEEE;
}
.other {
  margin-right: 40px;
  background-color: #FFFFFF;
}

  </style>
</head>

<body>
  <div class="row" style="margin-top: 20px;">
    <div class="col-sm-4">
      <div class="panel panel-default module">
        <div class="panel-heading">Connected Users
        </div>
          <ul class="list-group" style="height: 300px; overflow: scroll;" id="presence">
          </ul>
      </div>
    </div>
    <div class="col-sm-8">
      <div class="panel panel-default module">
        <div class="panel-heading">
          <div class="row">
            <div class="col-xs-6">
              <input id="src" type="text" name="src" input="input" class="form-control"/>
            </div>
            <div class="col-xs-offset-2 col-xs-4">
              <button id="connect" onclick="return false;" class="btn btn-info pull-right">Connect</button>
            </div>
          </div>
        </div>
        <ul style="height: 300px; overflow: scroll;" class="list-group" id="content">
        </ul>
        <div class="panel-footer">
          <div class="row">
            <div class="col-xs-12">
              <input id="msg" type="text" name="msg" input="input" class="form-control" placeholder="Type message and press Enter"/>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<script>
    $(document).ready(function() {
        var connected = false;
        $('#msg').prop('disabled', true);
        var bbt = null;
        $('#connect').click(function () {
          if(connected) {
            bbt.disconnect();
            $('#connect').text('Connect');
            $('#src').prop('disabled', false);
            $('#msg').val('');
            $('#msg').prop('disabled', true);
            $('#presence').html('');
            $('#constent').html('');
            connected = false;
          }else {
            if(! $('#src').val() ) return alert('You must set a username');
            if(! bbt) {
              bbt = new BBT('ACCESS_KEY', {auth_endpoint: '/auth', username: $('#src').val()});
              $('#msg').keypress(function (e) {
                if (e.which == 13) {
                  if($('#msg').val() != ""){
                    bbt.publish({device: 'bbt', service: 'chat_demo', resource: 'msg'}, {src: $('#src').val() || 'anonymous', msg: $('#msg').val()});
                    $('#msg').val('');
                  }else {
                    bbt.read({owner: 'beebotte', device: 'bbt_u2', service: 'tsensor', resource: 'temp'}, function(err, data) {
                      if(err) return console.log(err);
                      console.log(data);
                    });
                  }
                }
              });
            }else {
              bbt.setUsername($('#src').val());
              bbt.connect();
            }
            connected = true;
            $('#src').prop('disabled', true);
            $('#msg').val('');
            $('#msg').prop('disabled', false);
            $('#connect').text('Disconnect');
            var content = $('#content');
  
            bbt.subscribe( {device: 'presence:bbt', service: 'chat_demo', resource: 'msg'}, function(message){
              if((message.data.event === 'join' || message.data.event === 'connected')) {
                if(!$('#' + message.data.id).length) {
                  $('#presence').append('<li id="' + message.data.id + '" class="list-group-item">' + message.data.userinfo.username || message.data.id + '</li>');
                }
              }
            });

            bbt.subscribe( {device: 'bbt', service: 'chat_demo', resource: 'msg', read: true, write: true}, function(message){
              //console.log(message);
              var src = 'other';
              //if(message.data.src === $('#src').val()) src = 'self';
              content.append('<li class="list-group-item ' + src + '">' + message.data.src + ': ' + message.data.msg + '</li>');
              var objDiv = document.getElementById("content");
              objDiv.scrollTop = objDiv.scrollHeight;
            });
          }
        });
    });
</script>
</body>
</html>
                 
